services:
  kafka:
    image: apache/kafka:latest
    container_name: gst-kafka
    restart: unless-stopped
    ports:
      - "${KAFKA_EXTERNAL_PORT}:9092"
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=controller,broker
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9094
      - KAFKA_LISTENERS=INTERNAL://:9093,EXTERNAL://:9092,CONTROLLER://:9094
      - KAFKA_ADVERTISED_LISTENERS=INTERNAL://kafka:9093,EXTERNAL://localhost:${KAFKA_EXTERNAL_PORT}
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_HEAP_OPTS=-Xmx512M -Xms512M
    volumes:
      - kafka_data:/var/lib/kafka/data 
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'cat < /dev/null > /dev/tcp/localhost/9093'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  redis:
    image: redis:7-alpine
    container_name: gst-redis
    restart: unless-stopped
    ports:
      - "${REDIS_EXTERNAL_PORT}:6379"
    volumes:
      - redis_data:/data

  bot-gateway:
    build: 
      context: .
      dockerfile: bot-gateway/dockerfile
    image: ghcr.io/sustuna/sidequestgst/gst-quest-bot:latest 
    container_name: gst-bot-gateway
    restart: unless-stopped
    ports:
      - "${API_PORT}:8080"
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - KAFKA_BROKERS=kafka:9093
      - TARGET_GUILD_ID=${TARGET_GUILD_ID}
      - QUEST_GIVER_ID=${QUEST_GIVER_ID}
      - QUEST_PARTICIPANT_ID=${QUEST_PARTICIPANT_ID}
      - GOOGLE_SHEET_ID=${GOOGLE_SHEET_ID}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
      - RUST_LOG=info
      - API_ADDRESS=${API_ADDRESS}
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./credentials.json:/app/credentials.json:ro 
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_started

  sheet-worker:
    build: 
      context: .
      dockerfile: sheet-worker/dockerfile
    image: ghcr.io/sustuna/sidequestgst/gst-sheet-worker:latest
    container_name: gst-sheet-worker
    restart: unless-stopped
    environment:
      - KAFKA_BROKERS=kafka:9093
      - GOOGLE_SHEET_ID=${GOOGLE_SHEET_ID}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
      - RUST_LOG=info
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./credentials.json:/app/credentials.json:ro
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_started

volumes:
  kafka_data:
  redis_data: